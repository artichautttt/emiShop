<div class="container mt-5 mb-5" style="min-height: 80vh;">

  @if (loading) {
    <div class="text-center py-5">
      <div class="spinner-border text-warning" role="status"></div>
      <p class="mt-2 text-muted">Chargement des détails...</p>
    </div>
  }

  @else if (errorMsg) {
    <div class="alert alert-danger text-center">
      <h4>Oups !</h4>
      <p>{{ errorMsg }}</p>
      <a routerLink="/" class="btn btn-outline-danger">Retour à l'accueil</a>
    </div>
  }

  @else if (product) {

    <a routerLink="/" class="btn btn-outline-dark mb-4 border-0 ps-0 fw-bold">
      <i class="bi bi-arrow-left me-2"></i> Retour au catalogue
    </a>

    <div class="bg-white p-5 rounded shadow-sm">
      <div class="row">

        <div class="col-md-6 text-center mb-4 mb-md-0 position-relative">

          @if (product.discountPercentage > 0) {
            <span class="badge bg-danger position-absolute top-0 start-0 m-3 fs-5 shadow" style="z-index: 10;">
              PROMO -{{ product.discountPercentage | number:'1.0-0' }}%
            </span>
          }

          <img [src]="product.thumbnail"
               alt="{{ product.title }}"
               class="img-fluid rounded shadow-sm"
               style="max-height: 400px; object-fit: contain;">

          <div class="d-flex justify-content-center gap-2 mt-3 overflow-auto">
            @for (img of product.images; track img) {
              <img [src]="img" class="border rounded" style="width: 60px; height: 60px; object-fit: cover;">
            }
          </div>
        </div>

        <div class="col-md-6">
          <small class="text-uppercase text-muted fw-bold">{{ product.category }}</small>
          <h1 class="fw-bold mb-3">{{ product.title }}</h1>

          <div class="d-flex align-items-center mb-2">
            <h2 class="fw-bold text-danger mb-0">{{ product.price | number:'1.2-2' }} MAD</h2>

            @if (product.discountPercentage > 0) {
              <span class="text-decoration-line-through text-muted ms-3 fs-5">
                {{ (product.price / (1 - product.discountPercentage / 100)) | number:'1.2-2' }} MAD
              </span>
            }
          </div>

          <div class="mb-4 text-warning fs-5">
            <i class="bi bi-star-fill"></i> {{ product.rating }} / 5
            <span class="text-muted fs-6 ms-2">({{ product.stock }} en stock)</span>
          </div>

          <p class="lead text-secondary mb-5">{{ product.description }}</p>

          <button (click)="addToCart()"
                  class="btn btn-lg w-100 fw-bold py-3 transition-all"
                  [class.btn-success]="isAdded"
                  [class.btn-warning]="!isAdded">
            {{ isAdded ? 'Produit ajouté !' : 'Ajouter au panier' }}
          </button>

          <div class="mt-5">
            <h5 class="border-bottom pb-2">Infos techniques</h5>
            <ul class="list-unstyled mt-3">
              <li><strong>Marque:</strong> {{ product.brand }}</li>
              <li><strong>Référence:</strong> {{ product.sku }}</li>
              <li><strong>Poids:</strong> {{ product.weight }} kg</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="row mt-5">
        <div class="col-12">
          <div class="bg-light p-4 rounded">
            <h4 class="mb-4"><i class="bi bi-chat-left-text me-2"></i>Avis des clients</h4>

            @if (currentUser) {
              <div class="mb-4">
                <textarea [(ngModel)]="newComment" class="form-control mb-2" rows="3" placeholder="Partagez votre avis sur ce produit..."></textarea>
                <button (click)="sendComment()" class="btn btn-dark" [disabled]="!newComment.trim()">
                  Publier mon avis
                </button>
              </div>
            } @else {
              <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                <a routerLink="/auth" class="fw-bold">Connectez-vous</a> pour laisser un avis.
              </div>
            }

            @for (c of comments; track c) {
              <div class="bg-white p-3 rounded shadow-sm mb-3 border-start border-4 border-warning">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong class="text-dark">{{ c.userName }}</strong>
                  <small class="text-muted">{{ c.date?.toDate ? (c.date.toDate() | date:'short') : '' }}</small>
                </div>
                <p class="mb-0 text-secondary">{{ c.text }}</p>
              </div>
            } @empty {
              <p class="text-muted fst-italic">Aucun avis pour le moment. Soyez le premier !</p>
            }
          </div>
        </div>
      </div>

    </div>
  }
</div>
